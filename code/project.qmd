


```{python}
import pandas as pd

df_competition = pd.read_csv("../data/Competition.csv")
df_competitors  = pd.read_csv("../data/Competitors.csv")
df_games        = pd.read_csv("../data/Games.csv")
df_teams        = pd.read_csv("../data/Teams.csv")
df_ends         = pd.read_csv("../data/Ends.csv")
df_stones       = pd.read_csv("../data/Stones.csv")

```
```{python}

merged = pd.merge(
    df_stones,
    df_ends,
    on=["CompetitionID","SessionID","GameID","EndID","TeamID"],
    how="left"
)

df = pd.merge(
    merged,
    df_games,
    on=["CompetitionID","SessionID","GameID"],
    how="left"
)
df.columns = df.columns.str.lower().str.replace('id', '_id')
df.head()
```
```{python}
df.info()
```
```{python}
df.isnull().sum()
```
```{python}
print(df['powerplay'].value_counts(dropna=False).reset_index())
print(df['timeout'].value_counts(dropna=False).reset_index())
cols_to_fill = ['powerplay', 'timeout']
df[cols_to_fill] = df[cols_to_fill].fillna(0)
```
```{python}
df = df.dropna(subset=["stone_3_x"])
null_counts = df.isnull().sum()
print(null_counts)
```
```{python}
count = 0
for (cid, sid, gid, eid), game in df.groupby(['competition_id','session_id','game_id', 'end_id']):
    print(f"Competition {cid}, Session {sid}, Game {gid}, End {eid}")
    print(game[["team_id","lsfe","resultstr1","resultstr2"]])
    print("-" * 50)
    count += 1
    if count >= 10:
        break
```
```{python}
import pandas as pd

df = df.sort_values(["competition_id", "session_id", "game_id", "end_id"])

df["hammer"] = -1 

for (cid, sid, gid), game in df.groupby(["competition_id", "session_id", "game_id"]):
    game = game.sort_values("end_id")
    
    team1 = game["team_id1"].iloc[0]
    team2 = game["team_id2"].iloc[0]

    lsfe = game["lsfe"].iloc[0] 
    hammer_val = lsfe  
    
    # Loop through ends
    for eid, end in game.groupby("end_id"):
        # Assign hammer for this end
        df.loc[end.index, "hammer"] = hammer_val
        
        # Compute points for each team in this end
        points_team1 = end.loc[end["team_id"] == team1, "result"].iloc[0]
        points_team2 = end.loc[end["team_id"] == team2, "result"].iloc[0]
        
        # If hammer team scored, switch hammer for next end
        if (hammer_val == 1 and points_team1 > 0) or (hammer_val == 0 and points_team2 > 0):
            hammer_val = 1 - hammer_val 

```
```{python}
count = 0
for (cid, sid, gid, eid), game in df.groupby(['competition_id','session_id','game_id', 'end_id']):
    print(f"Competition {cid}, Session {sid}, Game {gid}, End {eid}")
    print(game[["team_id","lsfe","result","hammer"]])
    print("-" * 50)
    count += 1
    if count >= 8:
        break
```
```{python}
shots_per_team = df.groupby(["competition_id","session_id","game_id","end_id","team_id"]).size()
print(shots_per_team.describe())
print(shots_per_team[shots_per_team == 6])
cid, sid, gid, eid= 24250026, 18, 1, 9
df_end = df[(df["competition_id"] == cid) &
            (df["session_id"] == sid) &
            (df["game_id"] == gid) &
            (df["end_id"] == eid)][["team_id","end_id","result"]]

print(df_end)
df.loc[25375, ["team_id", "result"]] = [37, 1]
```
```{python}
import matplotlib.pyplot as plt

mean_points = df.groupby("end_id")["result"].mean()
plt.bar(mean_points.index.astype(str), mean_points.values, color='skyblue')
plt.show()

df[df["result"] >5][["game_id","session_id","competition_id","end_id","result"]].head()
#df.loc[df["result"] > 5, "result"] = pd.NA
```

```{python}

```